# vSAN
## 概要
- 実験日: 2022/09/23~2022/10/28
- vSAN

目次
- [vSAN](#vsan)
  - [概要](#概要)
  - [1. 今回の実験](#1-今回の実験)
  - [2. vSANとは](#2-vsanとは)
    - [2.1 SANとは?](#21-sanとは)
    - [2.2 DAS NAS SAN　の違い](#22-das-nas-sanの違い)
    - [2.3 主なSAN](#23-主なsan)
    - [2.4 Fibre Channerlとは](#24-fibre-channerlとは)
    - [2.5 Fibre Channelのデメリット](#25-fibre-channelのデメリット)
    - [2.6 iSCSIとは](#26-iscsiとは)
    - [2.7 仮想化基盤の特徴について](#27-仮想化基盤の特徴について)
  - [3. vSAN構築手順](#3-vsan構築手順)
    - [3.1 vSAN概要図](#31-vsan概要図)
  - [4. 補足](#4-補足)
    - [ブロックストレージとファイルストレージの違い](#ブロックストレージとファイルストレージの違い)
    - [キャッシュ層とキャパシティ層の違い](#キャッシュ層とキャパシティ層の違い)
    - [キャッシュ層とキャパシティ層の注意点](#キャッシュ層とキャパシティ層の注意点)
  - [5. まとめ](#5-まとめ)
  - [6. 参考文献](#6-参考文献)

## 1. 今回の実験
&nbsp; 今回の実験では､研究室の環境([詳細はこちら](./00-VM-Machines.md))を利用して､vSANの構築を目指した｡ 

&nbsp; 目的として､vSANに至るまでの歴史からvSANの設定方法について理解することである｡
## 2. vSANとは
- ストレージ仮想化ソフトウェアの1つ
- HCIにて､SANの機能を仮想化したもの
### 2.1 SANとは?
&nbsp; ストレージとサーバー間に対して､専用のネットワークを構築し接続することによって､高効率化や冗長化などを目的としたストレージに対する接続形態の1つ｡ 

　
&nbsp;主な特徴として､1つのストレージに対して､複数のサーバー情報を保存することができることから､最大限のリソースを利用することが可能になる｡また､サーバーが停止した際には､ストレージと接続している別のサーバーにアプリケーションを移すことができる｡そのため､耐障害性の問題を低減することができる｡

### 2.2 DAS NAS SAN　の違い
&nbsp; SAN以外にもDASやNASが存在する｡それぞれの違いについて表を以下に示す｡

|| DAS | NAS | SAN |
|:----| :---- | :---- | :---- |
| 特徴 | ･ブロックストレージ<br>･サーバーとストレージの直接接続|･ファイルストレージ<br>･同じLAN内に設置しサーバーとストレージを接続|･ブロックストレージ<br>･ストレージ専用のネットワークを構築しサーバーとストレージを接続|
|メリット|単純な構成|SANより単純な構成|他の2つの接続形態より､最大限のリソースを利用可能になる|
| デメリット | ･ホスト数の数だけストレージが必要である点<br>･ストレージが分散されることで把握が困難になる点|･同じLAN内のため､通信が混み合っている際は､スループット低下に直結する点 |･1つのストレージに複数のVMを入れることになるため管理が難しい<br>･専用のネットワークを構築する必要からコストが他の2つと比較して高い点|

- [ブロックストレージとファイルストレージの違い](#ブロックストレージとファイルストレージの違い)

### 2.3 主なSAN

- **Fibre Channelを利用したFC-SAN**
- **iSCSIを利用したIP-SAN**

### 2.4 Fibre Channerlとは
&nbsp; コンピュータとストレージなどの周辺機器を通信するプロトコルの1つ｡主な特徴として､2つある｡ 

- 1つ目は､高速な通信が提供できる点が挙げられる｡最大速度32Gbit/sを提供することができ､NASでは同じLAN内にストレージがあるため伝送速度が低下するがFibre channelではなりにくい点がある
- 2つ目は､高い伝送効率を提供できる点が挙げられる｡IP-SANでは､TCP/IP通信であるためTCPヘッダーには､様々な情報を付加して情報を伝達している｡一方で､Fibre channelはストレージ専用のプロトコルなため高効率な伝送を提供することが出来る

### 2.5 Fibre Channelのデメリット 
  - FC専用のルータやスイッチなどを別途購入する必要があるためコストがかかる
  - FC専用ネットワークを構築する必要がある
  - 専用のルータなので設定が難しい
  - メンテナンスコストが高い

### 2.6 iSCSIとは
&nbsp; コンピュータとストレージなどの周辺機器を通信するプロトコルの1つ｡主な特徴として､3つある｡

- 1つ目は､経費を抑えることが出来る点が挙げられる｡前述より､Fibre Channelでは専用の製品を購入することからコストが高い｡一方で､iSCSIでは､TCP/IPを利用することで､専用のルータやスイッチなどは必要ない
- 2つ目は､FC専用ネットワークの構築に労力を掛ける必要がない点が挙げられる｡iSCSIは､IPネットワークにて構成されるため新たに学習する必要が少ない
- 3つ目は､TCP/IPにて管理されることから管理やエラーがあった際に迅速に対応できる点が挙げられる｡iSCSIのパケットは､TCP通信で行われることから通信を全てIPに統合できることから管理を容易にすることができる｡また､TCPパケット内には､SCSIコマンドが入っているため通信エラーなどの問題の際には確認しやすい

### 2.7 仮想化基盤の特徴について

  - **3Tier**
    - 物理サーバー及びSAN､共有ストレージ装置の3層構造担っている
    - 3層それぞれ異なるメーカの機器を組み合わせることができるため自由に増設可能な点
    - 製品ごとのソフトウェアが異なるため設定するのが困難な点
  - **CI**
    - パッケージ化された物
    - 要件定義を細かく決定していないと増設の際にすべての設定を見直す必要があるため難しい
  - **HCI**
    - サーバー及びストレージネットワーク､ストレージプールの3層構造になっている
    - 3層構造にてソフトウェア上で接続する
    - **仮想的にSANをソフトウェア上で構成することをvSANという**
## 3. vSAN構築手順
### 3.1 vSAN概要図
!["概要図"](images/20221014vSphereClient/00design.drawio.png)
*図0 概要図*

1. ログイン
!["初期画面"](images/20221014vSphereClient/01initialScreen.png)
*図1 vSphere Clientログイン時の初期画面*

2. vcenter.nlab.localをクリックし､新規データセンターを作成する｡今回は､名前 = `Datacenter`をつける｡
!["データセンター作成"](images/20221014vSphereClient/02newDataCenter.png)
*図2 新規データセンター作成画面* 

3. 作成されたDatacenterを右クリックしホストを追加する｡それぞれのホストを1つのまとまりとして認識し､様々なサービスを可能にする｡

4. 名前と場所では､vCenter Serverがインストールされているホスト名またはIPアドレス = `192.168.100.12`を入力する｡

5. 接続設定欄ではユーザー名 = `root` パスワード = `P@ssw0rd`を入力する｡

6. ホストサマリにて設定した情報を確認する｡
![ホストサマリ](./images/20221014vSphereClient/03hostSummary.png)
*図3 ホストの追加 ホストサマリ確認画面*

7. ライセンスの割り当て欄では､ライセンスを持っているためLicense1が表示されている｡License1を選択する｡

8. ロックダウンモード及び仮想マシンの場所はデフォルトのまま設定する｡

9. 設定した情報を確認する
![設定の確認](images/20221014vSphereClient/04newHostConfig.png)
*図4 ホストの追加　確認画面*

10. EsxiがDatacenter内にあることを確認する｡その後､他の2台を同じように設定する｡その後､Datacenter内に､ホストが3台分入っていることを確認する｡

11. 管理画面にてDatacenter及びホストの確認をする｡
![Datacenter内にホストが3台分入っていることを確認した際の図](images/20221014vSphereClient/05datacenter.png)
*図5 ホスト確認画面*

1.  Datacenterにて､右クリックを押し新規クラスタを作成する｡クラスタを作成しvSANを構築することで､負荷に偏りがある際にvMotionなどのサーバー間で展開しているアプリケーションを移動することが可能になる｡

2.  基本欄では､名前 = `Cluster`､vSANを`ON`にする｡
![`確認`](images/20221014vSphereClient/06newCluster.png)
*図6 新規クラスタ確認画面*

14. Clusterを押し､構成欄のクイックスタートからホストの追加を選択する｡
![ホストの追加](images/20221014vSphereClient/07clusterAddhost.png)
*図7 ホストの追加画面*

15.  クラスタの構成をクリックし､ディスクの要求 vSANデータストア欄では､SSDをキャッシュ層に､HDDをキャパシティ層といったように､ホスト1から3までに対して設定する｡
![クラスタ構成画面](images/20221014vSphereClient/08clusterConfig.png)
*図8 クイックスタート クラスタの構成画面*
![ディスク要求画面](images/20221014vSphereClient/09clusterDisk.png)
*図9 クラスタ構成 ディスク要求画面*

16. クラスタ構成の確認画面にてvSANデータストア内のvSANディスクグループタイプ及びキャッシュサイズ､容量サイズについて確認する｡
![クラスタの構成確認画面](images/20221014vSphereClient/10clusterConfigLastHalf.png)
*図10 クラスタの構成 確認画面*

17. クラスタ画面に戻り､最近のタスクにてターゲット=`cluster`のステータスが`完了`になっていれば､正常に処理が終わっている｡
![クラスタ構成の処理画面](images/20221014vSphereClient/11afterSetupEsxi2Error.png)
*図11 クラスタ構成 処理画面*

18. クラスタ画面からvSANの欄を選択しプロアクティブモードからvSANが適切に構成しているかテストを行う｡仮想マシン作成テスト.ステータス=`成功`､ネットワークパフォーマンス.健全性ステータス=`パス`になれば適切に構成している｡
![仮想マシン作成テスト](images/20221014vSphereClient/12clusterMachineTest.png)
*図12 仮想マシン作成テスト*
![ネットワークパフォーマンステスト](images/20221014vSphereClient/13clusterNetworkTest.png)
*図13 ネットワークパフォーマンステスト*


## 4. 補足

### ブロックストレージとファイルストレージの違い
- ブロックストレージ:ストレージ領域をある範囲に切り出してブロックにして管理し割り当てる
- ファイルストレージ:ファイルやディレクトリにて階層的に管理する
### キャッシュ層とキャパシティ層の違い
- キャッシュ層:I/Oの処理を担う
- キャパシティ層:データの保存を担う
### キャッシュ層とキャパシティ層の注意点
- vSANを構築するためには、キャッシュ層つまり実行容量にカウントされないストレージデバイスが1台以上必要である｡そのため､高速な読み書きが可能なSSDを利用する
- HDDをキャッシュ層にすることはできない

## 5. まとめ
- vSANとは､ストレージ仮想化ソフトウェアである
- vSAN以外にも様々なストレージに対する接続形態が存在するが､事業規模に応じて変更する必要がある

## 6. 参考文献
